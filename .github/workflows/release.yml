name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  upload_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          
      - name: Check release status
        id: release_check
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          # Check if release already exists and has the required files
          # If release was created locally via release.sh, it will already have files
          if gh release view "v${VERSION}" >/dev/null 2>&1; then
            ASSETS=$(gh release view "v${VERSION}" --json assets --jq '.assets[].name' 2>/dev/null || echo "")
            if echo "$ASSETS" | grep -q "premiere-ae-sync-extension-v${VERSION}.zip" && \
               echo "$ASSETS" | grep -q "davinci-sync-extension-v${VERSION}.zip"; then
              echo "✅ Release already has required packages (created locally)"
              echo "skip_upload=true" >> $GITHUB_OUTPUT
            else
              echo "⚠️  Release exists but missing packages"
              echo "skip_upload=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Release doesn't exist yet"
            echo "skip_upload=false" >> $GITHUB_OUTPUT
          fi
          
          # Check if packages exist in repo (they're gitignored, so usually won't exist)
          PREM_AE_ZIP="dist/premiere-ae-sync-extension-v${VERSION}.zip"
          DAVINCI_ZIP="dist/davinci-sync-extension-v${VERSION}.zip"
          
          if [ -f "$PREM_AE_ZIP" ] && [ -f "$DAVINCI_ZIP" ]; then
            echo "✅ Found packages in repo"
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "⚠️  Packages not in repo (expected - created locally by release.sh)"
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Get tag message
        id: tag_message
        shell: bash
        run: |
          TAG_MESSAGE=$(git tag -l --format='%(contents)' ${{ github.ref_name }})
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$TAG_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload to GitHub Release
        if: steps.release_check.outputs.skip_upload != 'true' && steps.release_check.outputs.has_files == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ${{ steps.tag_message.outputs.message }}
            
            **Downloads:**
            
            After Effects & Premiere Pro: `premiere-ae-sync-extension-v${{ steps.version.outputs.version }}.zip`
            
            DaVinci Resolve: `davinci-sync-extension-v${{ steps.version.outputs.version }}.zip`
            
            Choose the appropriate package for your platform and application.
            
            **Security & Trust:**
            - ZXP package is digitally signed and verified (signed locally before upload)
            - Verify signature using ZXP Installer or ZXPSignCmd
          files: |
            dist/premiere-ae-sync-extension-v${{ steps.version.outputs.version }}.zip
            dist/davinci-sync-extension-v${{ steps.version.outputs.version }}.zip
          draft: false
          prerelease: false
          generate_release_notes: true

