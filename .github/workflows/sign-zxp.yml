name: Upload ZXP Release

on:
  push:
    tags:
      - "v*"

jobs:
  upload_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          
      - name: Check if ZXP exists
        run: |
          if [ ! -f "dist/zxp/com.sync.extension.zxp" ]; then
            echo "Error: ZXP file not found at dist/zxp/com.sync.extension.zxp"
            echo "Please run ./bin/release.sh locally to build the ZXP first"
            exit 1
          fi
          echo "âœ… ZXP file found"

      - name: Get tag message
        id: tag_message
        shell: bash
        run: |
          TAG_MESSAGE=$(git tag -l --format='%(contents)' ${{ github.ref_name }})
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$TAG_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ${{ steps.tag_message.outputs.message }}
            
            **Download:**
            - `com.sync.extension.zxp` - Unified extension for After Effects and Premiere Pro (works on Windows and macOS)
            
            **Security & Trust:**
            - Package is digitally signed and verified
            - SHA256 checksums are provided in `checksums.txt` for integrity verification
            - Verify checksums: `sha256sum -c checksums.txt` (Linux/macOS) or `certutil -hashfile com.sync.extension.zxp SHA256` (Windows)
          files: |
            dist/zxp/com.sync.extension.zxp
            dist/zxp/checksums.txt
          draft: false
          prerelease: false
          generate_release_notes: true
